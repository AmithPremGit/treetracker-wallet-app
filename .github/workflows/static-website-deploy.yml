name: Deploy NextJS to AWS Dev
on:
  push:
    branches:
      - main
    paths:
      - 'apps/web/**'
  workflow_dispatch:
env:
  project-directory: ./apps/web
  REPOSITORY: 'Greenstand/treetracker-wallet-app'
jobs:
  build:
    name: Build Next.js Static Site
    runs-on: ubuntu-latest
    if: |
      !contains(github.event.head_commit.message, 'skip-ci')
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'
          cache: 'yarn'
      - name: Install dependencies
        run: yarn install
      - name: Update next.config.js for static export
        run: |
          cat > ${{ env.project-directory }}/next.config.js << 'EOF'
          /** @type {import('next').NextConfig} */
          const nextConfig = {
            reactStrictMode: true,
            transpilePackages: ["wallet_state"],
            output: 'export',
            images: {
              unoptimized: true,
            },
          };
          module.exports = nextConfig;
          EOF
      - name: Set environment variables for dev
        run: |
          cat > ${{ env.project-directory }}/.env.local << EOF
          NEXT_PUBLIC_HOSTNAME=https://${{ secrets.DEV_CLOUDFRONT_DOMAIN }}
          EOF
      - name: Build for deployment
        run: |
          cd ${{ env.project-directory }}
          yarn build
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: static-site-build
          path: ${{ env.project-directory }}/out
          retention-days: 1
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: [build]
    if: |
      github.repository == 'Greenstand/treetracker-wallet-app'
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: static-site-build
          path: build
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      - name: Deploy to S3 (dev)
        run: |
          aws s3 sync build/ s3://${{ secrets.DEV_CDN_S3_BUCKET }}/ --delete
          aws cloudfront create-invalidation --distribution-id ${{ secrets.DEV_CDN_DISTRIBUTION_ID }} --paths "/*"
      - name: Deployment complete
        run: |
          echo "::notice title=Deployment Complete::Website deployed to https://${{ secrets.DEV_CLOUDFRONT_DOMAIN }}"